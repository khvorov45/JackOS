/** Handles memory operations */

class Memory {

    static Array memory;
    static int firstFreeBase;

    function void init() {
        let memory = 0;
        let firstFreeBase = 2049;
        do Memory.poke(2048, 14336);
        do Memory.poke(firstFreeBase, -1);
        return;
    }

    /** Returns the value of the main memory at this address */
    function int peek(int address) {
        return memory[address];
    }

    /** Sets the contents of the main memory at this address to value */
    function void poke(int address, int value) {
        let memory[address] = value;
        return;
    }

    /** Finds the allocates from the heap a memory block of the specified size
    and returns a reference to its base address */
    function int alloc(int size) {

        var int curBase, curFreeSize, sizeLeft, fullAllocSize, nextAddress;
        var int newBase;

        let curBase = firstFreeBase;

        while (true) {

            // Need to know the next address either way
            let nextAddress = Memory.peek(curBase);

            // This checks if we found the segment we were looking for
            if (size < Memory.peek(curBase - 1)) {

                let fullAllocSize = size + 1;

                // Figure out how much is left
                let curFreeSize = Memory.peek(curBase - 1);
                let sizeLeft = curFreeSize - fullAllocSize;
                
                // Change the segment's [-1] value to new size
                do Memory.poke(curBase - 1, fullAllocSize);

                // Add the size remaining after allocation to the new
                // list entry
                let newBase = curBase + fullAllocSize;
                do Memory.poke(newBase - 1, sizeLeft);

                // Add the pointer to the next list entry to the new list entry
                do Memory.poke(newBase, nextAddress);

                // Make sure the previous segment points to the new segment
                if (curBase = firstFreeBase) {
                    let firstFreeBase = newBase;
                }
                else {
                    do Sys.error(9000); // temporary
                }

                return curBase;
            }

            // Next list entry
            let curBase = nextAddress;

            // -1 means that there are no more entries in the list
            if (curBase = -1) {
                do Sys.error(1);
                return -1;
            }
        }
        return -1;
    }

    /** Deallocates the given object and frees its memory space */
    function void deAlloc(Array o) {
        return;
    }
}